# ============================
# üîß –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥ Nginx
# ============================

# –£–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –ø–æ–¥ –∫–æ—Ç–æ—Ä—ã–º –∑–∞–ø—É—â–µ–Ω Nginx (–≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ ‚Äî nginx)
user nginx;

# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ—Ä–∫–µ—Ä–æ–≤. auto ‚Äî –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø–æ–¥ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ CPU.
worker_processes auto;

# –û—à–∏–±–∫–∏ –∏ –≤–∞–∂–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –ø–∏—à—É—Ç—Å—è —Å—é–¥–∞
error_log /var/log/nginx/error.log warn;

# PID-—Ñ–∞–π–ª (–¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤)
pid /var/run/nginx.pid;


# ============================
# üîÅ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ–±—ã—Ç–∏–π (I/O)
# ============================
events {
    worker_connections 1024;  # –ú–∞–∫—Å–∏–º—É–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –Ω–∞ –æ–¥–∏–Ω –ø—Ä–æ—Ü–µ—Å—Å
}


# ============================
# üåç –û—Å–Ω–æ–≤–Ω–æ–π HTTP-–±–ª–æ–∫
# ============================
http {
    # –í–∫–ª—é—á–∞–µ–º –ª–æ–≥ –∑–∞–ø—Ä–æ—Å–æ–≤ (—É–¥–æ–±–Ω–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
    access_log /var/log/nginx/access.log;

    # –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –±—É—Ñ–µ—Ä–æ–≤ –∏ —Ç–∞–π–º–∞—É—Ç–æ–≤
    sendfile on;             # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç sendfile() ‚Äî –±—ã—Å—Ç—Ä–µ–µ –æ—Ç–¥–∞—ë—Ç —Ñ–∞–π–ª—ã
    tcp_nopush on;           # –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
    tcp_nodelay on;          # –£–º–µ–Ω—å—à–∞–µ—Ç –∑–∞–¥–µ—Ä–∂–∫–∏ –ø—Ä–∏ –ø–µ—Ä–µ–¥–∞—á–µ –¥–∞–Ω–Ω—ã—Ö
    keepalive_timeout 65;    # –¢–∞–π–º–∞—É—Ç –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    types_hash_max_size 2048;

    include /etc/nginx/mime.types;
    default_type application/octet-stream;  # –ï—Å–ª–∏ —Ç–∏–ø —Ñ–∞–π–ª–∞ –Ω–µ –∏–∑–≤–µ—Å—Ç–µ–Ω

    # ============================
    # üí® –ù–∞—Å—Ç—Ä–æ–π–∫–∏ GZIP-—Å–∂–∞—Ç–∏—è
    # ============================
    gzip on;  # –í–∫–ª—é—á–∞–µ–º gzip-—Å–∂–∞—Ç–∏–µ –æ—Ç–≤–µ—Ç–æ–≤ (—É—Å–∫–æ—Ä—è–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É)
    gzip_disable "msie6";  # –û—Ç–∫–ª—é—á–∞–µ–º –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
    gzip_vary on;  # –î–æ–±–∞–≤–ª—è–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ Vary: Accept-Encoding
    gzip_proxied any;  # –†–∞–∑—Ä–µ—à–∞–µ–º gzip –¥–∞–∂–µ –¥–ª—è –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
    gzip_comp_level 6;  # –°—Ç–µ–ø–µ–Ω—å —Å–∂–∞—Ç–∏—è (1‚Äì9)
    gzip_buffers 16 8k;  # –ë—É—Ñ–µ—Ä—ã –ø–æ–¥ gzip
    gzip_min_length 1024;  # –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –¥–ª—è —Å–∂–∞—Ç–∏—è (–≤ –±–∞–π—Ç–∞—Ö)
    gzip_types
        text/plain
        text/css
        text/javascript
        application/javascript
        application/json
        application/xml
        application/rss+xml
        image/svg+xml;  # –§–æ—Ä–º–∞—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ —Å–∂–∏–º–∞—Ç—å

    # ============================
    # üåê –°–µ—Ä–≤–µ—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    # ============================
    server {
        listen 80 default_server;  # HTTP (–ø–æ—Ä—Ç 80)
        # –ë–µ–∑ server_name ‚Üí —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–µ–∑–¥–µ, –Ω–∞ –ª—é–±–æ–º —Ö–æ—Å—Ç–µ

        # === API ‚Üí FastAPI backend ===
        location /api/ {
            # –£–¥–∞–ª—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å /api –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –Ω–∞ backend
            rewrite ^/api/(.*)$ /$1 break;

            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä backend –Ω–∞ –ø–æ—Ä—Ç 8000
            proxy_pass http://backend:8000;

            # –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –≤–∞–∂–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # –£–≤–µ–ª–∏—á–∏–º —Ç–∞–π–º–∞—É—Ç—ã (–µ—Å–ª–∏ backend –æ—Ç–≤–µ—á–∞–µ—Ç –¥–æ–ª–≥–æ)
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # === –í—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ ‚Üí Next.js frontend ===
        location / {
            proxy_pass http://frontend:3000;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫—ç—à–∞ –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤ (–µ—Å–ª–∏ –æ—Ç–¥–∞—ë—Ç —Ñ—Ä–æ–Ω—Ç)
            proxy_cache_bypass $http_upgrade;
        }
    }
}
